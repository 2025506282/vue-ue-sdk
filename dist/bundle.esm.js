function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(t)}function t(e){e=e||{};var t=this;this.cfg=e.peerConnectionOptions||{},this.cfg.sdpSemantics="unified-plan",this.pcClient=null,this.dcClient=null,this.tnClient=null,this.sdpConstraints={offerToReceiveAudio:1,offerToReceiveVideo:1},this.dataChannelOptions={ordered:!0};var n;this.video=((n=document.getElementById("streamingVideo")).muted="muted",n.addEventListener("loadstart",(function(){console.log("-------loadstart----------")}),!0),n.addEventListener("loadedmetadata",(function(){console.log("-------loadedmetadata----------"),t.onVideoInitialised&&t.onVideoInitialised()}),!0),n),this.cfg.offerExtmapAllowMixed=!1;var o=function(e){console.info("signaling state change:",e)},a=function(e){console.info("ice connection state change:",e)},i=function(e){console.info("ice gathering state change:",e)},r=function(e){console.log("handleOnTrack",e.streams),t.video.srcObject!==e.streams[0]&&(console.log("setting video stream from ontrack"),t.video.srcObject=e.streams[0])},c=function(e){console.log("ICE candidate",e),e.candidate&&e.candidate.candidate&&t.onWebRtcCandidate(e.candidate)};this.handleCandidateFromServer=function(e){console.log("ICE candidate: ",e);var n=new RTCIceCandidate(e);t.pcClient.addIceCandidate(n).then((function(){console.log("ICE candidate successfully added")}))},this.createOffer=function(){var e;t.pcClient&&(console.log("Closing existing PeerConnection"),t.pcClient.close(),t.pcClient=null),t.pcClient=new RTCPeerConnection(t.cfg),(e=t.pcClient).SetBitrate&&console.log("Hurray! there's RTCPeerConnection.SetBitrate function"),e.onsignalingstatechange=o,e.oniceconnectionstatechange=a,e.onicegatheringstatechange=i,e.ontrack=r,e.onicecandidate=c,t.dcClient=function(e,n,o){try{var a=e.createDataChannel(n,o);return console.log("Created datachannel (".concat(n,")")),a.onopen=function(){console.log("data channel (".concat(n,") connect")),t.onDataChannelConnected&&t.onDataChannelConnected()},a.onclose=function(){console.log("data channel (".concat(n,") closed"))},a.onmessage=function(e){t.onDataChannelMessage&&t.onDataChannelMessage(e.data)},a}catch(e){return console.warn("No data channel",e),null}}(t.pcClient,"cirrus",t.dataChannelOptions),function(e){e.createOffer(t.sdpConstraints).then((function(n){e.setLocalDescription(n),t.onWebRtcOffer&&(n.sdp=n.sdp.replace(/(a=fmtp:\d+ .*level-asymmetry-allowed=.*)\r\n/gm,"$1;x-google-start-bitrate=10000;x-google-max-bitrate=20000\r\n"),t.onWebRtcOffer(n))}),(function(){console.warn("Couldn't create offer")}))}(t.pcClient)},this.receiveAnswer=function(e){console.log("Received answer:\n".concat(e));var n=new RTCSessionDescription(e);t.pcClient.setRemoteDescription(n)},this.close=function(){t.pcClient&&(console.log("Closing existing peerClient"),t.pcClient.close(),t.pcClient=null),t.aggregateStatsIntervalId&&clearInterval(t.aggregateStatsIntervalId)},this.send=function(e){t.dcClient&&"open"==t.dcClient.readyState&&t.dcClient.send(e)},this.getStats=function(e){t.pcClient&&e&&t.pcClient.getStats(null).then((function(t){e(t)}))},this.aggregateStats=function(e){var n=(t.aggregatedStats||(t.aggregatedStats={}),function(e){var n={};e.forEach((function(e){"inbound-rtp"!=e.type||e.isRemote||"video"!=e.mediaType&&!e.id.toLowerCase().includes("video")||(n.timestamp=e.timestamp,n.bytesReceived=e.bytesReceived,n.framesDecoded=e.framesDecoded,n.packetsLost=e.packetsLost,n.bytesReceivedStart=t.aggregatedStats&&t.aggregatedStats.bytesReceivedStart?t.aggregatedStats.bytesReceivedStart:e.bytesReceived,n.framesDecodedStart=t.aggregatedStats&&t.aggregatedStats.framesDecodedStart?t.aggregatedStats.framesDecodedStart:e.framesDecoded,n.timestampStart=t.aggregatedStats&&t.aggregatedStats.timestampStart?t.aggregatedStats.timestampStart:e.timestamp,t.aggregatedStats&&t.aggregatedStats.timestamp&&(t.aggregatedStats.bytesReceived&&(n.bitrate=8*(n.bytesReceived-t.aggregatedStats.bytesReceived)/(n.timestamp-t.aggregatedStats.timestamp),n.bitrate=Math.floor(n.bitrate),n.lowBitrate=t.aggregatedStats.lowBitrate&&t.aggregatedStats.lowBitrate<n.bitrate?t.aggregatedStats.lowBitrate:n.bitrate,n.highBitrate=t.aggregatedStats.highBitrate&&t.aggregatedStats.highBitrate>n.bitrate?t.aggregatedStats.highBitrate:n.bitrate),t.aggregatedStats.bytesReceivedStart&&(n.avgBitrate=8*(n.bytesReceived-t.aggregatedStats.bytesReceivedStart)/(n.timestamp-t.aggregatedStats.timestampStart),n.avgBitrate=Math.floor(n.avgBitrate)),t.aggregatedStats.framesDecoded&&(n.framerate=(n.framesDecoded-t.aggregatedStats.framesDecoded)/((n.timestamp-t.aggregatedStats.timestamp)/1e3),n.framerate=Math.floor(n.framerate),n.lowFramerate=t.aggregatedStats.lowFramerate&&t.aggregatedStats.lowFramerate<n.framerate?t.aggregatedStats.lowFramerate:n.framerate,n.highFramerate=t.aggregatedStats.highFramerate&&t.aggregatedStats.highFramerate>n.framerate?t.aggregatedStats.highFramerate:n.framerate),t.aggregatedStats.framesDecodedStart&&(n.avgframerate=(n.framesDecoded-t.aggregatedStats.framesDecodedStart)/((n.timestamp-t.aggregatedStats.timestampStart)/1e3),n.avgframerate=Math.floor(n.avgframerate)))),"track"!=e.type||"video_label"!=e.trackIdentifier&&"video"!=e.kind||(n.framesDropped=e.framesDropped,n.framesReceived=e.framesReceived,n.framesDroppedPercentage=e.framesDropped/e.framesReceived*100,n.frameHeight=e.frameHeight,n.frameWidth=e.frameWidth,n.frameHeightStart=t.aggregatedStats&&t.aggregatedStats.frameHeightStart?t.aggregatedStats.frameHeightStart:e.frameHeight,n.frameWidthStart=t.aggregatedStats&&t.aggregatedStats.frameWidthStart?t.aggregatedStats.frameWidthStart:e.frameWidth),"candidate-pair"==e.type&&void 0!==e.currentRoundTripTime&&0!=e.currentRoundTripTime&&(n.currentRoundTripTime=e.currentRoundTripTime)})),t.aggregatedStats=n,t.onAggregatedStats&&t.onAggregatedStats(n)});t.aggregateStatsIntervalId=setInterval((function(){t.getStats(n)}),e)}}var n,o,a=null,i=(new Date).getTime(),r=new Map,c=null,s={receiving:!1,size:0,jpeg:void 0,height:0,width:0,valid:!1},d=void 0,l=void 0;function f(e){console.log(e)}function g(){setTimeout((function(){a&&a.video.play(),m(new Uint8Array([B]).buffer),s.valid&&(c.style.display="block")}),500)}function u(){!function(e,t,n){var o=document.getElementById("videoPlayOverlay");if(!o){var a=document.getElementById("player");(o=document.createElement("div")).id="videoPlayOverlay",a.appendChild(o)}for(;o.lastChild;)o.removeChild(o.lastChild);t&&o.appendChild(t),n&&o.addEventListener("click",(function e(t){n(t),o.removeEventListener("click",e)}));for(var i=o.classList,r=i.length-1;r>=0;r--)i.remove(i[r]);o.classList.add(e)}("hiddenState")}function m(e){a&&a.send(e)}var h=1,v=2,p=3,y=4;function S(o,i){function u(){var e=btoa(s.jpeg.reduce((function(e,t){return e+String.fromCharCode(t)}),""));c.src="data:image/jpeg;base64,"+e,c.onload=function(){s.height=c.naturalHeight,s.width=c.naturalWidth,k(),g(),x()}}return a=new t({peerConnectionOptions:i.peerConnectionOptions}),o.appendChild(a.video),o.appendChild(c),a.onWebRtcOffer=function(e){if(n&&1===n.readyState){var t=JSON.stringify(e);console.log("-> SS: offer:\n".concat(t)),n.send(t)}},a.onWebRtcCandidate=function(e){n&&1===n.readyState&&(console.log("-> SS: iceCandidate\n".concat(JSON.stringify(e,void 0,4))),n.send(JSON.stringify({type:"iceCandidate",candidate:e})))},a.onVideoInitialised=function(){n&&1===n.readyState&&(g(),x())},a.onDataChannelConnected=function(){Ce&&Ce(),n&&1===n.readyState&&f("WebRTC connected, waiting for video")},a.onDataChannelMessage=function(t){var n=new Uint8Array(t);if(s.receiving){var o=new Uint8Array(s.jpeg.length+n.length);o.set(s.jpeg,0),o.set(n,s.jpeg.length),s.jpeg=o,s.jpeg.length===s.size?(s.receiving=!1,s.valid=!0,console.log("received complete freeze frame ".concat(s.size)),u()):s.jpeg.length>s.size?(console.error("received bigger freeze frame than advertised: ".concat(s.jpeg.length,"/").concat(s.size)),s.jpeg=void 0,s.receiving=!1):console.log("received next chunk (".concat(n.length," bytes) of freeze frame: ").concat(s.jpeg.length,"/").concat(s.size))}else if(n[0]===h){!function(t){console.log(e(t)),console.log("recv:",t);var n=JSON.parse(t);if("event"!==n.command)return void console.log("unexpected response:",t);var o=n.func_name,a=r.get(o);a&&a(n.args)}(new TextDecoder("utf-16").decode(t.slice(1)))}else if(n[0]===v){var a=new TextDecoder("utf-16").decode(t.slice(1));console.log(a);var i=JSON.parse(a);"onScreenKeyboard"===i.command&&function(e){if(e.showOnScreenKeyboard){d.classList.remove("hiddenState");var t=Y(e.x,e.y);d.style.top=t.y.toString()+"px",d.style.left=(t.x-40).toString()+"px"}else d.classList.add("hiddenState"),l.blur()}(i)}else n[0]===p?(s.size=new DataView(n.slice(1,5).buffer).getInt32(0,!0),s.jpeg=n.slice(5),s.jpeg.length<s.size?(console.log("received first chunk of freeze frame: ".concat(s.jpeg.length,"/").concat(s.size)),s.receiving=!0):(console.log("received complete freeze frame: ".concat(s.jpeg.length,"/").concat(s.size)),u())):n[0]===y&&R()},function(e){if(!e)return;(function(e){e.onmouseenter=function(t){var n=new DataView(new ArrayBuffer(1));n.setUint8(0,W),m(n.buffer),e.pressMouseButtons(t)},e.onmouseleave=function(t){var n=new DataView(new ArrayBuffer(1));n.setUint8(0,_),m(n.buffer),e.releaseMouseButtons(t)}})(e),function(e){var t=[9,8,7,6,5,4,3,2,1,0],n={};function o(t,o){var a=new DataView(new ArrayBuffer(2+6*o.length));a.setUint8(0,t),a.setUint8(1,o.length);for(var i=2,r=0;r<o.length;r++){var c=o[r],s=c.clientX-e.offsetLeft,d=c.clientY-e.offsetTop,l=X(s,d);a.setUint16(i,l.x,!0),i+=2,a.setUint16(i,l.y,!0),i+=2,a.setUint8(i,n[c.identifier],!0),i+=1,a.setUint8(i,255*c.force,!0),i+=1}m(a.buffer)}e.ontouchstart=function(e){for(var a=0;a<e.changedTouches.length;a++)i=e.changedTouches[a],r=void 0,void 0===(r=t.pop())&&console.log("exhausted touch indentifiers"),n[i.identifier]=r;var i,r;o(H,e.changedTouches),e.preventDefault()},e.ontouchend=function(e){o(V,e.changedTouches);for(var a=0;a<e.changedTouches.length;a++)i=e.changedTouches[a],t.push(n[i.identifier]),delete n[i.identifier];var i;e.preventDefault()},e.ontouchmove=function(e){o(P,e.touches),e.preventDefault()}}(e)}(a.video),"ontouchstart"in document.documentElement&&function(e){null===document.getElementById("hiddenInput")&&((l=document.createElement("input")).id="hiddenInput",l.maxLength=0,e.appendChild(l));null===document.getElementById("editTextButton")&&((d=document.createElement("button")).id="editTextButton",d.innerHTML="edit text",e.appendChild(d),d.classList.add("hiddenState"),d.addEventListener("click",(function(){l.focus()})))}(o),a?(console.log("Creating offer"),f("Starting connection to server, please wait"),a.createOffer()):(console.log("WebRTC player not setup, cannot create offer"),f("Unable to setup video")),a.video}var w,C=0,b=1,D={controlScheme:b,suppressBrowserKeys:!0,fakeMouseWithTouches:!1};function R(){c.style.display="none",s.valid=!1}function k(){if(0!==s.width&&0!==s.height){var e,t;e=s.width,t=s.height,0,0,c.style.width=e+"px",c.style.height=t+"px",c.style.left="0px",c.style.top="0px"}}function x(){var e=document.getElementById("player");e&&(T(),e.classList.contains("fixed-size")||(e.getBoundingClientRect(),function(){var e=document.getElementById("player"),t=e.getElementsByTagName("video");if(e&&t.length>0){var n=e.clientHeight/e.clientWidth,o=t[0].videoHeight/t[0].videoWidth;if(n>o){var a=n/o;X=function(t,n){var o=t/e.clientWidth,i=a*(n/e.clientHeight-.5)+.5;return o<0||o>1||i<0||i>1?{inRange:!1,x:65535,y:65535}:{inRange:!0,x:65536*o,y:65536*i}},Y=function(t,n){var o=(n/65536-.5)/a+.5;return{x:t/65536*e.clientWidth,y:o*e.clientHeight}},N=function(t,n){return{x:32767*(t/(.5*e.clientWidth)),y:32767*(a*n/(.5*e.clientHeight))}}}else{var i=o/n;X=function(t,n){var o=i*(t/e.clientWidth-.5)+.5,a=n/e.clientHeight;return o<0||o>1||a<0||a>1?{inRange:!1,x:65535,y:65535}:{inRange:!0,x:65536*o,y:65536*a}},Y=function(t,n){var o=n/65536;return{x:((t/65536-.5)/i+.5)*e.clientWidth,y:o*e.clientHeight}},N=function(t,n){return{x:32767*(i*t/(.5*e.clientWidth)),y:32767*(n/(.5*e.clientHeight))}}}}}(),k()))}function T(){if((new Date).getTime()-i>1e3){var e=document.getElementById("player");if(!e)return;var t={Console:"setres "+e.clientWidth+"x"+e.clientHeight};F(t),console.log(t),i=(new Date).getTime()}else console.log("Resizing too often - skipping"),clearTimeout(o),o=setTimeout(T,1e3)}function E(){clearTimeout(w),w=setTimeout((function(){x()}),500)}var B=1,U=50,I=60,L=61,O=62,W=70,_=71,z=72,A=73,M=74,j=75,H=80,V=81,P=82;function F(e){!function(e,t){var n=JSON.stringify(t),o=new DataView(new ArrayBuffer(3+2*n.length)),a=0;o.setUint8(a,e),a++,o.setUint16(a,n.length,!0),a+=2;for(var i=0;i<n.length;i++)o.setUint16(a,n.charCodeAt(i),!0),a+=2;m(o.buffer)}(U,e)}var X=void 0,N=void 0,Y=void 0;function J(e,t,n,o){var a=X(e,t),i=N(n,o),r=new DataView(new ArrayBuffer(9));r.setUint8(0,M),r.setUint16(1,a.x,!0),r.setUint16(3,a.y,!0),r.setInt16(5,i.x,!0),r.setInt16(7,i.y,!0),m(r.buffer)}function $(e,t,n){var o=X(t,n),a=new DataView(new ArrayBuffer(6));a.setUint8(0,z),a.setUint8(1,e),a.setUint16(2,o.x,!0),a.setUint16(4,o.y,!0),m(a.buffer)}function q(e,t,n){var o=X(t,n),a=new DataView(new ArrayBuffer(6));a.setUint8(0,A),a.setUint8(1,e),a.setUint16(2,o.x,!0),a.setUint16(4,o.y,!0),m(a.buffer)}function K(e,t,n){var o=X(t,n),a=new DataView(new ArrayBuffer(7));a.setUint8(0,j),a.setInt16(1,e,!0),a.setUint16(3,o.x,!0),a.setUint16(5,o.y,!0),m(a.buffer)}var G=0,Q=1,Z=2,ee=3,te=4,ne=1,oe=2,ae=4,ie=8,re=16;function ce(e,t,n){e&ne&&q(G,t,n),e&oe&&q(Z,t,n),e&ae&&q(Q,t,n),e&ie&&q(ee,t,n),e&re&&q(te,t,n)}function se(e,t,n){e&ne&&$(G,t,n),e&oe&&$(Z,t,n),e&ae&&$(Q,t,n),e&ie&&$(ee,t,n),e&re&&$(te,t,n)}function de(e){var t=e.width/2,n=e.height/2;function o(){document.pointerLockElement===e||document.mozPointerLockElement===e?(console.log("Pointer locked"),document.addEventListener("mousemove",a,!1)):(console.log("The pointer lock status is now unlocked"),document.removeEventListener("mousemove",a,!1))}function a(e){t+=e.movementX,n+=e.movementY,t>void 0&&(t-=void 0),n>void 0&&(n-=void 0),t<0&&(t=void 0+t),n<0&&(n=void 0-n),J(t,n,e.movementX,e.movementY)}e.requestPointerLock=e.requestPointerLock||e.mozRequestPointerLock,document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock,e.onclick=function(){e.requestPointerLock()},document.addEventListener("pointerlockchange",o,!1),document.addEventListener("mozpointerlockchange",o,!1),e.onmousedown=function(e){$(e.button,t,n)},e.onmouseup=function(e){q(e.button,t,n)},e.onmousewheel=function(e){K(e.wheelDelta,t,n)},e.pressMouseButtons=function(e){se(e.buttons,t,n)},e.releaseMouseButtons=function(e){ce(e.buttons,t,n)}}function le(e){return e>=112&&e<=123||9===e}var fe=8,ge=16,ue=17,me=18,he=253,ve=254,pe=255;function ye(e){return e.keyCode===ge&&"ShiftRight"===e.code?he:e.keyCode===ue&&"ControlRight"===e.code?ve:e.keyCode===me&&"AltRight"===e.code?pe:e.keyCode}function Se(){R(),x(),setTimeout((function(){!function(){if(window.WebSocket=window.WebSocket||window.MozWebSocket,!window.WebSocket)return void alert("Your browser doesn't support WebSocket");(n=new WebSocket("ws://".concat(we,"/"))).onmessage=function(e){console.log("<- SS: ".concat(e.data));var t,n,o=JSON.parse(e.data);"config"===o.type?function(e){var t=S(document.getElementById("player"),e);switch(x(),D.controlScheme){case b:!function(e){e.onmousemove=function(e){J(e.offsetX,e.offsetY,e.movementX,e.movementY),e.preventDefault()},e.onmousedown=function(e){$(e.button,e.offsetX,e.offsetY),e.preventDefault()},e.onmouseup=function(e){q(e.button,e.offsetX,e.offsetY),e.preventDefault()},e.oncontextmenu=function(e){q(e.button,e.offsetX,e.offsetY),e.preventDefault()},"onmousewheel"in e?e.onmousewheel=function(e){K(e.wheelDelta,e.offsetX,e.offsetY),e.preventDefault()}:e.addEventListener("DOMMouseScroll",(function(e){K(-120*e.detail,e.offsetX,e.offsetY),e.preventDefault()}),!1),e.pressMouseButtons=function(e){se(e.buttons,e.offsetX,e.offsetY)},e.releaseMouseButtons=function(e){ce(e.buttons,e.offsetX,e.offsetY)}}(t);break;case C:de(t);break;default:console.log("ERROR: Unknown control scheme ".concat(D.controlScheme)),de(t)}}(o):"playerCount"===o.type?console.log("playerCount"):"answer"===o.type?(n=o,a.receiveAnswer(n),a.onAggregatedStats=function(e){e.timestamp,e.timestampStart},a.aggregateStats(1e3)):"iceCandidate"===o.type?(t=o.candidate,a&&a.handleCandidateFromServer(t)):console.log("invalid SS message type: ".concat(o.type))},n.onerror=function(e){console.log("WS error: ".concat(JSON.stringify(e)))},n.onclose=function(e){console.log("WS closed: ".concat(JSON.stringify(e.code)," - ").concat(e.reason)),n=void 0;var t=document.getElementById("player");a&&(t.removeChild(a.video),a.close(),a=void 0),f("Disconnected: ".concat(e.reason))}}()}),1e3),u()}var we="localhost:80",Ce=null;function be(e,t){console.log("ws to signal server: ",e),we=e,Ce=t,window.addEventListener("resize",x,!0),window.addEventListener("orientationchange",E),(c=document.createElement("img")).id="freezeFrameOverlay",c.style.display="none",c.style.pointerEvents="none",c.style.position="absolute",c.style.zIndex="30",document.onkeydown=function(e){m(new Uint8Array([I,ye(e),e.repeat]).buffer),e.keyCode===fe&&document.onkeypress({charCode:fe}),le(e.keyCode)&&e.preventDefault()},document.onkeyup=function(e){m(new Uint8Array([L,ye(e)]).buffer),le(e.keyCode)&&e.preventDefault()},document.onkeypress=function(e){var t=new DataView(new ArrayBuffer(3));t.setUint8(0,O),t.setUint16(1,e.charCode,!0),m(t.buffer)},Se()}function De(e,t,n){var o={command:"event",func_name:e,args:t};console.log("send:",o),r.set(e,n),F(o)}function Re(e,t){r.set(e,t)}function ke(e){r.delete(e)}function xe(e,t,n,o,a,i,r,c,s,d){"boolean"!=typeof r&&(s=c,c=r,r=!1);const l="function"==typeof n?n.options:n;let f;if(e&&e.render&&(l.render=e.render,l.staticRenderFns=e.staticRenderFns,l._compiled=!0,a&&(l.functional=!0)),o&&(l._scopeId=o),i?(f=function(e){(e=e||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(e=__VUE_SSR_CONTEXT__),t&&t.call(this,s(e)),e&&e._registeredComponents&&e._registeredComponents.add(i)},l._ssrRegister=f):t&&(f=r?function(e){t.call(this,d(e,this.$root.$options.shadowRoot))}:function(e){t.call(this,c(e))}),f)if(l.functional){const e=l.render;l.render=function(t,n){return f.call(n),e(t,n)}}else{const e=l.beforeCreate;l.beforeCreate=e?[].concat(e,f):[f]}return n}var Te=function(){this.$createElement;return this._self._c,this._m(0)};Te._withStripped=!0;var Ee=xe({render:Te,staticRenderFns:[function(){var e=this.$createElement,t=this._self._c||e;return t("div",{attrs:{id:"player"}},[t("div",{attrs:{id:"videoPlayOverlay"}}),this._v(" "),t("video",{staticStyle:{width:"100%",height:"100%"},attrs:{id:"streamingVideo",playsinline:""}})])}]},void 0,{},"data-v-4a3c8f35",!1,void 0,!1,void 0,void 0,void 0);export{Ee as UEPlayer,Re as api_register,De as api_send,ke as api_unregister,be as app_load};
