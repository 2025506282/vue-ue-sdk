import{openBlock as e,createElementBlock as t,pushScopeId as n,popScopeId as o,createElementVNode as a}from"vue";function i(e){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i(e)}function r(e){e=e||{};var t=this;this.cfg=e.peerConnectionOptions||{},this.cfg.sdpSemantics="unified-plan",this.pcClient=null,this.dcClient=null,this.tnClient=null,this.sdpConstraints={offerToReceiveAudio:1,offerToReceiveVideo:1},this.dataChannelOptions={ordered:!0};var n;this.video=((n=document.getElementById("streamingVideo")).muted="muted",n.addEventListener("loadedmetadata",(function(){t.onVideoInitialised&&t.onVideoInitialised()}),!0),n),this.cfg.offerExtmapAllowMixed=!1;var o=function(e){console.info("signaling state change:",e)},a=function(e){console.info("ice connection state change:",e)},i=function(e){console.info("ice gathering state change:",e)},r=function(e){console.log("handleOnTrack",e.streams),t.video.srcObject!==e.streams[0]&&(console.log("setting video stream from ontrack"),t.video.srcObject=e.streams[0])},c=function(e){console.log("ICE candidate",e),e.candidate&&e.candidate.candidate&&t.onWebRtcCandidate(e.candidate)};this.handleCandidateFromServer=function(e){console.log("ICE candidate: ",e);var n=new RTCIceCandidate(e);t.pcClient.addIceCandidate(n).then((function(){console.log("ICE candidate successfully added")}))},this.createOffer=function(){var e;t.pcClient&&(console.log("Closing existing PeerConnection"),t.pcClient.close(),t.pcClient=null),t.pcClient=new RTCPeerConnection(t.cfg),(e=t.pcClient).SetBitrate&&console.log("Hurray! there's RTCPeerConnection.SetBitrate function"),e.onsignalingstatechange=o,e.oniceconnectionstatechange=a,e.onicegatheringstatechange=i,e.ontrack=r,e.onicecandidate=c,t.dcClient=function(e,n,o){try{var a=e.createDataChannel(n,o);return console.log("Created datachannel (".concat(n,")")),a.onopen=function(){console.log("data channel (".concat(n,") connect")),t.onDataChannelConnected&&t.onDataChannelConnected()},a.onclose=function(){console.log("data channel (".concat(n,") closed"))},a.onmessage=function(e){t.onDataChannelMessage&&t.onDataChannelMessage(e.data)},a}catch(e){return console.warn("No data channel",e),null}}(t.pcClient,"cirrus",t.dataChannelOptions),function(e){e.createOffer(t.sdpConstraints).then((function(n){e.setLocalDescription(n),t.onWebRtcOffer&&(n.sdp=n.sdp.replace(/(a=fmtp:\d+ .*level-asymmetry-allowed=.*)\r\n/gm,"$1;x-google-start-bitrate=10000;x-google-max-bitrate=20000\r\n"),t.onWebRtcOffer(n))}),(function(){console.warn("Couldn't create offer")}))}(t.pcClient)},this.receiveAnswer=function(e){console.log("Received answer:\n".concat(e));var n=new RTCSessionDescription(e);t.pcClient.setRemoteDescription(n)},this.close=function(){t.pcClient&&(console.log("Closing existing peerClient"),t.pcClient.close(),t.pcClient=null),t.aggregateStatsIntervalId&&clearInterval(t.aggregateStatsIntervalId)},this.send=function(e){t.dcClient&&"open"==t.dcClient.readyState&&t.dcClient.send(e)},this.getStats=function(e){t.pcClient&&e&&t.pcClient.getStats(null).then((function(t){e(t)}))},this.aggregateStats=function(e){var n=(t.aggregatedStats||(t.aggregatedStats={}),function(e){var n={};e.forEach((function(e){"inbound-rtp"!=e.type||e.isRemote||"video"!=e.mediaType&&!e.id.toLowerCase().includes("video")||(n.timestamp=e.timestamp,n.bytesReceived=e.bytesReceived,n.framesDecoded=e.framesDecoded,n.packetsLost=e.packetsLost,n.bytesReceivedStart=t.aggregatedStats&&t.aggregatedStats.bytesReceivedStart?t.aggregatedStats.bytesReceivedStart:e.bytesReceived,n.framesDecodedStart=t.aggregatedStats&&t.aggregatedStats.framesDecodedStart?t.aggregatedStats.framesDecodedStart:e.framesDecoded,n.timestampStart=t.aggregatedStats&&t.aggregatedStats.timestampStart?t.aggregatedStats.timestampStart:e.timestamp,t.aggregatedStats&&t.aggregatedStats.timestamp&&(t.aggregatedStats.bytesReceived&&(n.bitrate=8*(n.bytesReceived-t.aggregatedStats.bytesReceived)/(n.timestamp-t.aggregatedStats.timestamp),n.bitrate=Math.floor(n.bitrate),n.lowBitrate=t.aggregatedStats.lowBitrate&&t.aggregatedStats.lowBitrate<n.bitrate?t.aggregatedStats.lowBitrate:n.bitrate,n.highBitrate=t.aggregatedStats.highBitrate&&t.aggregatedStats.highBitrate>n.bitrate?t.aggregatedStats.highBitrate:n.bitrate),t.aggregatedStats.bytesReceivedStart&&(n.avgBitrate=8*(n.bytesReceived-t.aggregatedStats.bytesReceivedStart)/(n.timestamp-t.aggregatedStats.timestampStart),n.avgBitrate=Math.floor(n.avgBitrate)),t.aggregatedStats.framesDecoded&&(n.framerate=(n.framesDecoded-t.aggregatedStats.framesDecoded)/((n.timestamp-t.aggregatedStats.timestamp)/1e3),n.framerate=Math.floor(n.framerate),n.lowFramerate=t.aggregatedStats.lowFramerate&&t.aggregatedStats.lowFramerate<n.framerate?t.aggregatedStats.lowFramerate:n.framerate,n.highFramerate=t.aggregatedStats.highFramerate&&t.aggregatedStats.highFramerate>n.framerate?t.aggregatedStats.highFramerate:n.framerate),t.aggregatedStats.framesDecodedStart&&(n.avgframerate=(n.framesDecoded-t.aggregatedStats.framesDecodedStart)/((n.timestamp-t.aggregatedStats.timestampStart)/1e3),n.avgframerate=Math.floor(n.avgframerate)))),"track"!=e.type||"video_label"!=e.trackIdentifier&&"video"!=e.kind||(n.framesDropped=e.framesDropped,n.framesReceived=e.framesReceived,n.framesDroppedPercentage=e.framesDropped/e.framesReceived*100,n.frameHeight=e.frameHeight,n.frameWidth=e.frameWidth,n.frameHeightStart=t.aggregatedStats&&t.aggregatedStats.frameHeightStart?t.aggregatedStats.frameHeightStart:e.frameHeight,n.frameWidthStart=t.aggregatedStats&&t.aggregatedStats.frameWidthStart?t.aggregatedStats.frameWidthStart:e.frameWidth),"candidate-pair"==e.type&&void 0!==e.currentRoundTripTime&&0!=e.currentRoundTripTime&&(n.currentRoundTripTime=e.currentRoundTripTime)})),t.aggregatedStats=n,t.onAggregatedStats&&t.onAggregatedStats(n)});t.aggregateStatsIntervalId=setInterval((function(){t.getStats(n)}),e)}}var c,s,d=null,l=(new Date).getTime(),f=new Map,g=null,u={receiving:!1,size:0,jpeg:void 0,height:0,width:0,valid:!1},m=void 0,h=void 0;function v(e){console.log(e)}function p(){setTimeout((function(){d&&d.video.play(),S(new Uint8Array([O]).buffer),u.valid&&(g.style.display="block")}),500)}function y(){!function(e,t,n){var o=document.getElementById("videoPlayOverlay");if(!o){var a=document.getElementById("player");(o=document.createElement("div")).id="videoPlayOverlay",a.appendChild(o)}for(;o.lastChild;)o.removeChild(o.lastChild);t&&o.appendChild(t),n&&o.addEventListener("click",(function e(t){n(t),o.removeEventListener("click",e)}));for(var i=o.classList,r=i.length-1;r>=0;r--)i.remove(i[r]);o.classList.add(e)}("hiddenState")}function S(e){d&&d.send(e)}var w=1,C=2,b=3,D=4;function k(e,t){function n(){var e=btoa(u.jpeg.reduce((function(e,t){return e+String.fromCharCode(t)}),""));g.src="data:image/jpeg;base64,"+e,g.onload=function(){u.height=g.naturalHeight,u.width=g.naturalWidth,U(),p(),I()}}return d=new r({peerConnectionOptions:t.peerConnectionOptions}),e.appendChild(d.video),e.appendChild(g),d.onWebRtcOffer=function(e){if(c&&1===c.readyState){var t=JSON.stringify(e);console.log("-> SS: offer:\n".concat(t)),c.send(t)}},d.onWebRtcCandidate=function(e){c&&1===c.readyState&&(console.log("-> SS: iceCandidate\n".concat(JSON.stringify(e,void 0,4))),c.send(JSON.stringify({type:"iceCandidate",candidate:e})))},d.onVideoInitialised=function(){c&&1===c.readyState&&(p(),I())},d.onDataChannelConnected=function(){xe&&xe(),c&&1===c.readyState&&v("WebRTC connected, waiting for video")},d.onDataChannelMessage=function(e){var t=new Uint8Array(e);if(u.receiving){var o=new Uint8Array(u.jpeg.length+t.length);o.set(u.jpeg,0),o.set(t,u.jpeg.length),u.jpeg=o,u.jpeg.length===u.size?(u.receiving=!1,u.valid=!0,console.log("received complete freeze frame ".concat(u.size)),n()):u.jpeg.length>u.size?(console.error("received bigger freeze frame than advertised: ".concat(u.jpeg.length,"/").concat(u.size)),u.jpeg=void 0,u.receiving=!1):console.log("received next chunk (".concat(t.length," bytes) of freeze frame: ").concat(u.jpeg.length,"/").concat(u.size))}else if(t[0]===w){!function(e){console.log(i(e)),console.log("recv:",e);var t=JSON.parse(e);if("event"!==t.command)return void console.log("unexpected response:",e);var n=t.func_name,o=f.get(n);o&&o(t.args)}(new TextDecoder("utf-16").decode(e.slice(1)))}else if(t[0]===C){var a=new TextDecoder("utf-16").decode(e.slice(1));console.log(a);var r=JSON.parse(a);"onScreenKeyboard"===r.command&&function(e){if(e.showOnScreenKeyboard){m.classList.remove("hiddenState");var t=G(e.x,e.y);m.style.top=t.y.toString()+"px",m.style.left=(t.x-40).toString()+"px"}else m.classList.add("hiddenState"),h.blur()}(r)}else t[0]===b?(u.size=new DataView(t.slice(1,5).buffer).getInt32(0,!0),u.jpeg=t.slice(5),u.jpeg.length<u.size?(console.log("received first chunk of freeze frame: ".concat(u.jpeg.length,"/").concat(u.size)),u.receiving=!0):(console.log("received complete freeze frame: ".concat(u.jpeg.length,"/").concat(u.size)),n())):t[0]===D&&E()},function(e){if(!e)return;(function(e){e.onmouseenter=function(t){var n=new DataView(new ArrayBuffer(1));n.setUint8(0,j),S(n.buffer),e.pressMouseButtons(t)},e.onmouseleave=function(t){var n=new DataView(new ArrayBuffer(1));n.setUint8(0,H),S(n.buffer),e.releaseMouseButtons(t)}})(e),function(e){var t=[9,8,7,6,5,4,3,2,1,0],n={};function o(e){var o=t.pop();void 0===o&&console.log("exhausted touch indentifiers"),n[e.identifier]=o}function a(e){t.push(n[e.identifier]),delete n[e.identifier]}function i(t,o){var a=new DataView(new ArrayBuffer(2+6*o.length));a.setUint8(0,t),a.setUint8(1,o.length);for(var i=2,r=0;r<o.length;r++){var c=o[r],s=c.clientX-e.offsetLeft,d=c.clientY-e.offsetTop,l=K(s,d);a.setUint16(i,l.x,!0),i+=2,a.setUint16(i,l.y,!0),i+=2,a.setUint8(i,n[c.identifier],!0),i+=1,a.setUint8(i,255*c.force,!0),i+=1}S(a.buffer)}e.ontouchstart=function(e){for(var t=0;t<e.changedTouches.length;t++)o(e.changedTouches[t]);i(N,e.changedTouches),e.preventDefault()},e.ontouchend=function(e){i(J,e.changedTouches);for(var t=0;t<e.changedTouches.length;t++)a(e.changedTouches[t]);e.preventDefault()},e.ontouchmove=function(e){i(_,e.touches),e.preventDefault()}}(e)}(d.video),"ontouchstart"in document.documentElement&&function(e){null===document.getElementById("hiddenInput")&&((h=document.createElement("input")).id="hiddenInput",h.maxLength=0,e.appendChild(h));null===document.getElementById("editTextButton")&&((m=document.createElement("button")).id="editTextButton",m.innerHTML="edit text",e.appendChild(m),m.classList.add("hiddenState"),m.addEventListener("click",(function(){h.focus()})))}(e),d?(console.log("Creating offer"),v("Starting connection to server, please wait"),d.createOffer()):(console.log("WebRTC player not setup, cannot create offer"),v("Unable to setup video")),d.video}var R,x=0,B=1,T={controlScheme:B,suppressBrowserKeys:!0,fakeMouseWithTouches:!1};function E(){g.style.display="none",u.valid=!1}function U(){if(0!==u.width&&0!==u.height){var e,t;e=u.width,t=u.height,0,0,g.style.width=e+"px",g.style.height=t+"px",g.style.left="0px",g.style.top="0px"}}function I(){var e=document.getElementById("player");e&&(L(),e.classList.contains("fixed-size")||(e.getBoundingClientRect(),function(){var e=document.getElementById("player"),t=e.getElementsByTagName("video");if(e&&t.length>0){var n=e.clientHeight/e.clientWidth,o=t[0].videoHeight/t[0].videoWidth;if(n>o){var a=n/o;K=function(t,n){var o=t/e.clientWidth,i=a*(n/e.clientHeight-.5)+.5;return o<0||o>1||i<0||i>1?{inRange:!1,x:65535,y:65535}:{inRange:!0,x:65536*o,y:65536*i}},G=function(t,n){var o=(n/65536-.5)/a+.5;return{x:t/65536*e.clientWidth,y:o*e.clientHeight}},$=function(t,n){return{x:32767*(t/(.5*e.clientWidth)),y:32767*(a*n/(.5*e.clientHeight))}}}else{var i=o/n;K=function(t,n){var o=i*(t/e.clientWidth-.5)+.5,a=n/e.clientHeight;return o<0||o>1||a<0||a>1?{inRange:!1,x:65535,y:65535}:{inRange:!0,x:65536*o,y:65536*a}},G=function(t,n){var o=n/65536;return{x:((t/65536-.5)/i+.5)*e.clientWidth,y:o*e.clientHeight}},$=function(t,n){return{x:32767*(i*t/(.5*e.clientWidth)),y:32767*(n/(.5*e.clientHeight))}}}}}(),U()))}function L(){if((new Date).getTime()-l>1e3){var e=document.getElementById("player");if(!e)return;var t={Console:"setres "+e.clientWidth+"x"+e.clientHeight};q(t),console.log(t),l=(new Date).getTime()}else console.log("Resizing too often - skipping"),clearTimeout(s),s=setTimeout(L,1e3)}function W(){clearTimeout(R),R=setTimeout((function(){I()}),500)}var O=1,z=50,A=60,M=61,P=62,j=70,H=71,V=72,Y=73,X=74,F=75,N=80,J=81,_=82;function q(e){!function(e,t){var n=JSON.stringify(t),o=new DataView(new ArrayBuffer(3+2*n.length)),a=0;o.setUint8(a,e),a++,o.setUint16(a,n.length,!0),a+=2;for(var i=0;i<n.length;i++)o.setUint16(a,n.charCodeAt(i),!0),a+=2;S(o.buffer)}(z,e)}var K=void 0,$=void 0,G=void 0;function Q(e,t,n,o){var a=K(e,t),i=$(n,o),r=new DataView(new ArrayBuffer(9));r.setUint8(0,X),r.setUint16(1,a.x,!0),r.setUint16(3,a.y,!0),r.setInt16(5,i.x,!0),r.setInt16(7,i.y,!0),S(r.buffer)}function Z(e,t,n){var o=K(t,n),a=new DataView(new ArrayBuffer(6));a.setUint8(0,V),a.setUint8(1,e),a.setUint16(2,o.x,!0),a.setUint16(4,o.y,!0),S(a.buffer)}function ee(e,t,n){var o=K(t,n),a=new DataView(new ArrayBuffer(6));a.setUint8(0,Y),a.setUint8(1,e),a.setUint16(2,o.x,!0),a.setUint16(4,o.y,!0),S(a.buffer)}function te(e,t,n){var o=K(t,n),a=new DataView(new ArrayBuffer(7));a.setUint8(0,F),a.setInt16(1,e,!0),a.setUint16(3,o.x,!0),a.setUint16(5,o.y,!0),S(a.buffer)}var ne=0,oe=1,ae=2,ie=3,re=4,ce=1,se=2,de=4,le=8,fe=16;function ge(e,t,n){e&ce&&ee(ne,t,n),e&se&&ee(ae,t,n),e&de&&ee(oe,t,n),e&le&&ee(ie,t,n),e&fe&&ee(re,t,n)}function ue(e,t,n){e&ce&&Z(ne,t,n),e&se&&Z(ae,t,n),e&de&&Z(oe,t,n),e&le&&Z(ie,t,n),e&fe&&Z(re,t,n)}function me(e){var t=e.width/2,n=e.height/2;function o(){document.pointerLockElement===e||document.mozPointerLockElement===e?(console.log("Pointer locked"),document.addEventListener("mousemove",a,!1)):(console.log("The pointer lock status is now unlocked"),document.removeEventListener("mousemove",a,!1))}function a(e){t+=e.movementX,n+=e.movementY,t>undefined&&(t-=undefined),n>undefined&&(n-=undefined),t<0&&(t=undefined+t),n<0&&(n=undefined-n),Q(t,n,e.movementX,e.movementY)}e.requestPointerLock=e.requestPointerLock||e.mozRequestPointerLock,document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock,e.onclick=function(){e.requestPointerLock()},document.addEventListener("pointerlockchange",o,!1),document.addEventListener("mozpointerlockchange",o,!1),e.onmousedown=function(e){Z(e.button,t,n)},e.onmouseup=function(e){ee(e.button,t,n)},e.onmousewheel=function(e){te(e.wheelDelta,t,n)},e.pressMouseButtons=function(e){ue(e.buttons,t,n)},e.releaseMouseButtons=function(e){ge(e.buttons,t,n)}}function he(e){return e>=112&&e<=123||9===e}var ve=8,pe=16,ye=17,Se=18,we=253,Ce=254,be=255;function De(e){return e.keyCode===pe&&"ShiftRight"===e.code?we:e.keyCode===ye&&"ControlRight"===e.code?Ce:e.keyCode===Se&&"AltRight"===e.code?be:e.keyCode}function ke(){E(),I(),setTimeout((function(){!function(){if(window.WebSocket=window.WebSocket||window.MozWebSocket,!window.WebSocket)return void alert("Your browser doesn't support WebSocket");(c=new WebSocket("ws://".concat(Re,"/"))).onmessage=function(e){console.log("<- SS: ".concat(e.data));var t,n,o=JSON.parse(e.data);"config"===o.type?function(e){var t=k(document.getElementById("player"),e);switch(I(),T.controlScheme){case B:!function(e){e.onmousemove=function(e){Q(e.offsetX,e.offsetY,e.movementX,e.movementY),e.preventDefault()},e.onmousedown=function(e){Z(e.button,e.offsetX,e.offsetY),e.preventDefault()},e.onmouseup=function(e){ee(e.button,e.offsetX,e.offsetY),e.preventDefault()},e.oncontextmenu=function(e){ee(e.button,e.offsetX,e.offsetY),e.preventDefault()},"onmousewheel"in e?e.onmousewheel=function(e){te(e.wheelDelta,e.offsetX,e.offsetY),e.preventDefault()}:e.addEventListener("DOMMouseScroll",(function(e){te(-120*e.detail,e.offsetX,e.offsetY),e.preventDefault()}),!1),e.pressMouseButtons=function(e){ue(e.buttons,e.offsetX,e.offsetY)},e.releaseMouseButtons=function(e){ge(e.buttons,e.offsetX,e.offsetY)}}(t);break;case x:me(t);break;default:console.log("ERROR: Unknown control scheme ".concat(T.controlScheme)),me(t)}}(o):"playerCount"===o.type?console.log("playerCount"):"answer"===o.type?(n=o,d.receiveAnswer(n),d.onAggregatedStats=function(e){e.timestamp,e.timestampStart},d.aggregateStats(1e3)):"iceCandidate"===o.type?(t=o.candidate,d&&d.handleCandidateFromServer(t)):console.log("invalid SS message type: ".concat(o.type))},c.onerror=function(e){console.log("WS error: ".concat(JSON.stringify(e)))},c.onclose=function(e){console.log("WS closed: ".concat(JSON.stringify(e.code)," - ").concat(e.reason)),c=void 0;var t=document.getElementById("player");d&&(t.removeChild(d.video),d.close(),d=void 0),v("Disconnected: ".concat(e.reason))}}()}),1e3),y()}var Re="localhost:80",xe=null;function Be(e,t){console.log("ws to signal server: ",e),Re=e,xe=t,window.addEventListener("resize",I,!0),window.addEventListener("orientationchange",W),(g=document.createElement("img")).id="freezeFrameOverlay",g.style.display="none",g.style.pointerEvents="none",g.style.position="absolute",g.style.zIndex="30",document.onkeydown=function(e){S(new Uint8Array([A,De(e),e.repeat]).buffer),e.keyCode===ve&&document.onkeypress({charCode:ve}),he(e.keyCode)&&e.preventDefault()},document.onkeyup=function(e){S(new Uint8Array([M,De(e)]).buffer),he(e.keyCode)&&e.preventDefault()},document.onkeypress=function(e){var t=new DataView(new ArrayBuffer(3));t.setUint8(0,P),t.setUint16(1,e.charCode,!0),S(t.buffer)},ke()}function Te(e,t,n){var o={command:"event",func_name:e,args:t};console.log("send:",o),f.set(e,n),q(o)}function Ee(e,t){f.set(e,t)}function Ue(e){f.delete(e)}var Ie=function(e){return n("data-v-1745ecb2"),e=e(),o(),e},Le={id:"player"},We=[Ie((function(){return a("div",{id:"videoPlayOverlay"},null,-1)})),Ie((function(){return a("video",{id:"streamingVideo",playsinline:"",style:{width:"100%",height:"100%"}},null,-1)}))],Oe={__name:"UEPlayer",setup:function(n){return function(n,o){return e(),t("div",Le,We)}},__scopeId:"data-v-1745ecb2",__file:"src/Components/ue-player/UEPlayer.vue"};export{Oe as UEPlayer,Ee as api_register,Te as api_send,Ue as api_unregister,Be as app_load};
